<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="description" content="">

        <link rel="stylesheet" href="css/stylePostit.css" />

        <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.1/themes/base/jquery-ui.css" />
        <link type="text/css" href="http://code.jquery.com/ui/1.8.1/themes/base/jquery.ui.datepicker.css" />

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/i18n/jquery.ui.datepicker-fr.min.js"></script>

        <style type="text/css">
            .ui-datepicker
            {
                z-index: 100002;
            }
        </style>

        <script type="text/javascript">
            $(document).ready(function(){
                $('#container .sortable-list').sortable({
                    connectWith: '#container .sortable-list'
                });

                $("input#date").datepicker();
            });

            $(function(){
				lister();
				
				$('#suppr_dialog').dialog({
                    autoOpen: false,
                    width: 380,
                    resizable:false,
                    modal:true,
                    buttons: {
                        "Oui": function() {

                            $(this).dialog("close");
                        },
                        "Non": function() {
                            $(this).dialog("close");
                        }
                    }
                });

                $('#dialog').dialog({
                    autoOpen: false,
                    width: 400,
                    resizable:false,
                    modal:true,
                    buttons: {
                        "Appliquer": function() {
                            $(this).dialog("close");
                        },
                        "Annuler": function() {
                            $(this).dialog("close");
                        }
                    }
                });

            });
			
			function getURLParameters(paramName){
				var sURL = window.document.URL.toString();  
				if (sURL.indexOf("?") > 0){
					var arrParams = sURL.split("?");         
					var arrURLParams = arrParams[1].split("&");      
					var arrParamNames = new Array(arrURLParams.length);
					var arrParamValues = new Array(arrURLParams.length);     
					var i = 0;
					for (i=0;i<arrURLParams.length;i++){
						var sParam =  arrURLParams[i].split("=");
						arrParamNames[i] = sParam[0];
						if (sParam[1] != "")
							arrParamValues[i] = unescape(sParam[1]);
						else
						arrParamValues[i] = "No Value";
					}
					for (i=0;i<arrURLParams.length;i++){
						if(arrParamNames[i] == paramName) {
							return arrParamValues[i];
						}
					}
				}
				return "";
			}
			
			function lister() {
				var idProject = getURLParameters("idProject");
				$.ajax({
						type: 'GET',
						url: 'ajax/project1.json',
						// TODO remettre url: 'http://10.11.145.91:1342/ServiceProject.svc/projects/'+idProject,
						dataType: 'json',
						success: function(response){          
							construirePagePostits(response.Data);
						},
						error: function() {
							alert('erreur');                   
						}
				});
			}
			
			function construirePagePostits(data) {
				var contenuHTML = '';
				if (data.length > 0) {
					var project = data[0];
					$('#nomProjet').html(project.Name);
					
					// steps
					var steps = project.Steps;
					if (steps.length > 0) {
						for (var i = 0; i < steps.length; i++) { 
							console.log("steps id = " + steps[i].ID + " nb tasks : " + steps[i].Tasks.length);
							
							contenuHTML += '<div id="step'+steps[i].ID+'" class="steps">';
							contenuHTML += '<div class="titreSteps">';
							contenuHTML += steps[i].Name;
							contenuHTML += '</div>';
                
							contenuHTML += '<ul class="sortable-list">';
                    		
							// tasks = postits
							if (steps[i].Tasks.length > 0) {
								for (var j = 0; j < steps[i].Tasks.length; j++) { 
									console.log("tasks id = " + steps[i].Tasks[j].ID);
									contenuHTML += '<li class="sortable-item">';
									contenuHTML += '<div class="postits">';
									contenuHTML += '<div class="titrePostits">';
									contenuHTML += steps[i].Tasks[j].Name;
									contenuHTML += '</div>';
									contenuHTML += '<div class="contenuPostits">';
									contenuHTML += steps[i].Tasks[j].Content;
									contenuHTML += '</div>';
									contenuHTML += '<div class="lienPostits">';
									contenuHTML += '<a href="javascript:void(0)" onclick="modif_onclick('+steps[i].Tasks[j].ID+');">Edit</a> | <a href="javascript:void(0)" onclick="suppr_onclick('+steps[i].Tasks[j].ID+');">Suppr</a>';
									contenuHTML += '</div>';
									contenuHTML += '</div>';
									contenuHTML += '</li>';
                    			}
							}
							contenuHTML += '</ul>';
							contenuHTML += '</div>';
						}
					}
				}
				$('#container').html(contenuHTML);
						
			}

            function suppr_onclick(id_postit){
                $("#id_postit_suppr").val(id_postit);
                $('#suppr_dialog').dialog('open');
                return false;
            }

            function modif_onclick(id_postit){
                $('#dialog').dialog('open');
                return false;
            }


            function ajout_onclick(){
                $('#dialog').dialog('open');
                return false;
            }
        </script>
    </head>
    <body>
        <div id="section-header">
            <h3 id="nomProjet"></h3>
            <div id="ajout"><a href="javascript:void(0)" id="ajoutPostit" onclick="ajout_onclick();">Ajout postit</a></div>
        </div>
        <div id="container">
           
        </div>

        <div id="dialog" title="Postit">
            <form>
                <div id="formBlock">
                    <p>
                        <label for="titre">Titre :</label>
                        <input type="text" id="titre" />
                    </p>
                    <p>
                        <label for="auteur">Auteur :</label>
                        <input type="text" id="auteur" />
                    </p>
                    <p>
                        <label for="contenu">Contenu :</label>
                        <textarea id="contenu" rows="2" cols="30"></textarea>
                    </p>
                    <p>
                        <label for="date">Date :</label>
                        <input type="text" id="date" readonly="readonly" />
                    </p>
                </div>
            </form>
        </div>

        <div id="suppr_dialog" title="Suppression d'un postit">
            <input type="hidden" id="id_postit" value="">
            <h2>Voulez-vous vraiment supprimer ce postit ? </h2>
        </div>
    </body>
</html>
