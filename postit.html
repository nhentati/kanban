<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="description" content="">

        <link rel="stylesheet" href="css/stylePostit.css" />
		
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.1/themes/base/jquery-ui.css" />
        <link type="text/css" href="http://code.jquery.com/ui/1.8.1/themes/base/jquery.ui.datepicker.css" />

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/i18n/jquery.ui.datepicker-fr.min.js"></script>
		
		<link rel="stylesheet" href="css/jquery-ui-timepicker-addon.css" />
		<script type="text/javascript" src="js/jquery-ui-timepicker-addon.js"></script>
		<script type="text/javascript" src="js/jquery-ui-sliderAccess.js"></script>
		
        <style type="text/css">
            .ui-datepicker
            {
                z-index: 100002;
            }
        </style>

		<script type="text/javascript" language="javascript">
						function validate(elem){
							if ($("#txt_"+elem).val()==""){
								$("#err_"+elem).html("&nbsp;Err&nbsp;");
							}
							else{
								$("#err_"+elem).html("");
							}
						}
						
						function initErr(){
							$("#err_id_postit").html("");	
							$("#err_name").html("");
							$("#err_content").html("");	
							$("#err_completed_at").html("");
							$("#err_completion").html("");	
							$("#err_creted_at").html("");	
							$("#err_estimated_time").html("");	
							$("#err_priority").html("");
							$("#err_spend_time").html("");	
							$("#err_step_id").html("");	
							$("#err_update_at").html("");	
						}		
						
						function initElemDialog(){
							$('#txt_id_postit').val('');
							$('#txt_name').val('');
							$('#txt_content').val('');
							$('#txt_completed_at').val('');
							$('#txt_completion').val('');
							$('#txt_created_at').val('');		
							$('#txt_estimated_time').val('');
							$('#txt_priority').val('');
							$('#txt_spend_time').val('');
							$('#txt_step_id').val('');
							$('#txt_update_at').val('');
						}
						
						
						
						
            $(document).ready(function(){
				$("input#date").datetimepicker();
				$("input#date").datetimepicker('setDate', new Date());
            });

            $(function(){
				lister();
				
				$('#suppr_dialog').dialog({
                    autoOpen: false,
                    width: 380,
                    resizable:false,
                    modal:true,
                    buttons: {
                        "Oui": function() {

                            $(this).dialog("close");
                        },
                        "Non": function() {
                            $(this).dialog("close");
                        }
                    }
                });

                $('#dialog').dialog({
                    autoOpen: false,
                    width: 400,
                    resizable:false,
                    modal:true,
                    buttons: {
                        "Appliquer": function() {
                            $(this).dialog("close");
                        },
                        "Annuler": function() {
                            $(this).dialog("close");
                        }
                    }
                });

            });
			
			function getURLParameters(paramName){
				var sURL = window.document.URL.toString();  
				if (sURL.indexOf("?") > 0){
					var arrParams = sURL.split("?");         
					var arrURLParams = arrParams[1].split("&");      
					var arrParamNames = new Array(arrURLParams.length);
					var arrParamValues = new Array(arrURLParams.length);     
					var i = 0;
					for (i=0;i<arrURLParams.length;i++){
						var sParam =  arrURLParams[i].split("=");
						arrParamNames[i] = sParam[0];
						if (sParam[1] != "")
							arrParamValues[i] = unescape(sParam[1]);
						else
						arrParamValues[i] = "No Value";
					}
					for (i=0;i<arrURLParams.length;i++){
						if(arrParamNames[i] == paramName) {
							return arrParamValues[i];
						}
					}
				}
				return "";
			}
			
			function lister() {
				var idProject = getURLParameters("idProject");
				$.ajax({
						type: 'GET',
						url: 'ajax/project1.json',
						// TODO remettre url: 'http://10.11.145.91:1342/ServiceProject.svc/projects/'+idProject,
						dataType: 'json',
						success: function(response){          
							construirePagePostits(response.Data);
						},
						error: function() {
							alert('erreur');                   
						}
				});
			}
			
			function construirePagePostits(data) {
				var contenuHTML = '';
				if (data.length > 0) {
					var project = data[0];
					$('#nomProjet').html(project.Name);
					
					// steps
					var steps = project.Steps;
					if (steps.length > 0) {
						for (var i = 0; i < steps.length; i++) { 
							//console.log("steps id = " + steps[i].ID + " nb tasks : " + steps[i].Tasks.length);
							
							contenuHTML += '<div class="steps">';
							contenuHTML += '<div class="titreSteps">';
							contenuHTML += steps[i].Name;
							contenuHTML += '</div>';
                
							contenuHTML += '<ul class="sortable-list" id="stepId'+steps[i].ID+'">';
                    		
							// tasks = postits
							if (steps[i].Tasks.length > 0) {
								for (var j = 0; j < steps[i].Tasks.length; j++) { 
									//console.log("tasks id = " + steps[i].Tasks[j].ID);
									contenuHTML += '<li class="sortable-item" id="taskId'+steps[i].Tasks[j].ID+'">';
									contenuHTML += '<div class="postits">';
									contenuHTML += '<div class="titrePostits">';
									//contenuHTML += steps[i].Tasks[j].ID+' - '+steps[i].Tasks[j].Name;
									contenuHTML += steps[i].Tasks[j].Name;
									contenuHTML += '</div>';
									contenuHTML += '<div class="contenuPostits">';
									contenuHTML += steps[i].Tasks[j].Content;
									contenuHTML += '</div>';
									contenuHTML += '<div class="lienPostits">';
									contenuHTML += '<a href="javascript:void(0)" onclick="modif_onclick('+steps[i].Tasks[j].ID+');">Edit</a> | <a href="javascript:void(0)" onclick="suppr_onclick('+steps[i].Tasks[j].ID+');">Suppr</a>';
									contenuHTML += '</div>';
									contenuHTML += '</div>';
									contenuHTML += '</li>';
                    			}
							}
							contenuHTML += '</ul>';
							contenuHTML += '</div>';
						}
					}
				}
				$('#container').html(contenuHTML);
				$('#container .sortable-list').sortable({
                    connectWith: '#container .sortable-list',
					stop: function( event, ui ) {
						var taskDeplace = $(ui.item[0]);
						var idTaskDeplace = taskDeplace.attr("id").split("taskId")[1];
						var idStepCible = taskDeplace.parents('ul').attr("id").split("stepId")[1];
						console.log("TODO task " + idTaskDeplace+ " change de step " + idStepCible);
					}
                });		
			}

			function suppr_onclick(id_postit){
				$("#id_postit_suppr").val(id_postit);
				$('#suppr_dialog').dialog('open');
				return false;
			}
						
			function modif_onclick(id_postit){
				initErr();
				
				$.ajax({
					type: 'GET',
					url: 'http://10.11.145.91:1342/ServiceProject.svc/projects/'+id_postit,
					dataType: 'json',
					success: function(response){          
						$('#txt_id_postit').val(response.Data.ID);
						$('#txt_name').val(response.Data.Name);
						$('#txt_content').val(response.Data.Content);
						$('#txt_completed_at').val(response.Data.Completed_at);
						$('#txt_completion').val(response.Data.Completion);
						$('#txt_created_at').val(response.Data.Created_at);
						$('#txt_estimated_time').val(response.Data.Estimated_time);
						$('#txt_priority').val(response.Data.Priority);
						$('#txt_spend_time').val(response.Data.Spend_time);
						$('#txt_step_id').val(response.Data.StepID);
						$('#txt_update_at').val(response.Data.Updated_at);
						$('#dialog').dialog('open');
					},
					error: function() {
						alert('erreur');                   
					}
				});
				return false;
			}


            function ajout_onclick(){
				initErr();
				initElemDialog();
                $('#dialog').dialog('open');
                return false;
            }
        </script>
    </head>
    <body>
        <div id="section-header">
            <h3 id="nomProjet"></h3>
            <div id="ajout"><a href="javascript:void(0)" id="ajoutPostit" onclick="ajout_onclick();">Ajout postit</a></div>
        </div>
        <div id="container">
           
        </div>

        <div id="dialog" title="Postit">
            <form>
                <div id="formBlock">
                    <p style="display:none;">
						<label for="txtid_project">Id:</label>
						<input type="text" id="txtid_project" readonly="readonly" />
						<span id="errid_project" class="info"></span>
					</p>
					<p>
						<label for="txtproject">Name:</label>
						<input type="text" id="txtproject" onBlur="validate('project');" />
						<span id="err_project" class="info"></span>
					</p>
					<p>
						<label for="txtauthor">Author : </label>
						<form name="formulaire">
						<select name="boite1" onChange="choix(this.form)">
						<option selected>....Choisissez un auteur....</option>
						<option>Nader</option>
						<option>Rija</option>
						<option>Alain</option>
						</select> 
					</p>
					<p>
                        <label for="titre">Content :</label>
                        <input type="text" id="txtcontent" />
                    </p>
                    <p>
                        <label for="completed">Completed at :</label>
                        <input type="text" id="txtcomplated_at" />
                    </p>
                    <p>
                        <label for="txtcompletion">Completion :</label>
						<input type="text" id="txtcompletion" />
					</p>
					
                    <p>
                        <label for="txtcreated_at">Created at :</label>
                        <input type="text" id="txtcreated_at" readonly="readonly" />
                    </p>
					<p>
                        <label for="txtestimated_time">Estimated time :</label>
                        <input type="text" id="txtestimated_time" />
                    </p>
					<p>
                        <label for="txtestimated_time">Priority :</label>
                        <input type="text" id="txtestimated_time" />
                    </p>
					<p>
                        <label for="txtetime_spend">Spend time :</label>
                        <input type="text" id="txtetime_spend" />
                    </p>
					<p>
                        <label for="txtstep_id">Step id:</label>
                        <input type="text" id="txtstep_id" />
                    </p>
					<p>
                        <label for="txtupdate_at">Update at :</label>
                        <input type="text" id="txtupdate_at" />
                    </p>
                </div>
            </form>
        </div>

        <div id="suppr_dialog" title="Suppression d'un postit">
            <input type="hidden" id="id_postit" value="">
            <h2>Voulez-vous vraiment supprimer ce postit ? </h2>
        </div>
    </body>
</html>
